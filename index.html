<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>Cognition Note Pro - 極致雲端筆記體驗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts & Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <!-- Monaco Editor CSS -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.css">
  <style>
    :root {
      --accent: #10b981;
      /* Emerald */
      --accent-glow: rgba(16, 185, 129, 0.4);
      --bg: #090e1a;
      --sidebar-bg: rgba(15, 23, 42, 0.95);
      --panel-bg: rgba(30, 41, 59, 0.4);
      --border: rgba(255, 255, 255, 0.08);
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --glass: blur(20px);
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: 'Inter', 'PingFang TC', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      height: 100vh;
      overflow: hidden;
      background-image:
        radial-gradient(circle at 0% 0%, rgba(16, 185, 129, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 100% 100%, rgba(99, 102, 241, 0.1) 0%, transparent 40%);
    }

    /* --- Login Overlay --- */
    #login-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(50px);
    }

    .login-card {
      background: var(--panel-bg);
      padding: 48px;
      border-radius: 32px;
      border: 1px solid var(--border);
      width: 440px;
      text-align: center;
      box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.8);
    }

    .login-card h1 {
      font-family: 'Outfit', sans-serif;
      font-size: 32px;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .input-group {
      margin-top: 24px;
      text-align: left;
    }

    .input-group label {
      display: block;
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      color: white;
      font-family: inherit;
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    .btn-glow {
      width: 100%;
      margin-top: 32px;
      background: var(--accent);
      color: #000;
      font-weight: 700;
      padding: 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 24px var(--accent-glow);
    }

    .btn-glow:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px var(--accent-glow);
    }

    /* --- App Layout --- */
    #app-root {
      display: flex;
      height: 100vh;
      opacity: 0;
      transform: scale(0.98);
    }

    #app-root.active {
      opacity: 1;
      transform: scale(1);
    }

    /* Sidebar Navigation */
    .nav-rail {
      width: 80px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 0;
      z-index: 100;
    }

    .nav-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      cursor: pointer;
      margin-bottom: 16px;
      position: relative;
    }

    .nav-icon:hover,
    .nav-icon.active {
      color: var(--accent);
      background: rgba(16, 185, 129, 0.1);
    }

    .nav-icon.active::after {
      content: '';
      position: absolute;
      left: -15px;
      width: 4px;
      height: 24px;
      background: var(--accent);
      border-radius: 0 4px 4px 0;
      box-shadow: 2px 0 10px var(--accent-glow);
    }

    /* File Explorer Panle */
    .explorer-pane {
      width: 300px;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: var(--glass);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .explorer-header {
      padding: 30px 24px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .explorer-header h2 {
      font-family: 'Outfit';
      margin: 0;
      font-size: 20px;
    }

    .search-box {
      margin: 0 20px 20px;
      position: relative;
    }

    .search-box i {
      position: absolute;
      left: 14px;
      top: 12px;
      color: var(--text-dim);
    }

    .search-box input {
      padding-left: 40px;
      background: rgba(0, 0, 0, 0.2);
      font-size: 13px;
    }

    .file-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 12px;
    }

    .file-item {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--text-dim);
    }

    .file-item:hover,
    .file-item.active {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
    }

    .file-item.active {
      background: rgba(16, 185, 129, 0.08);
      color: var(--accent);
    }

    .file-item i {
      font-size: 18px;
    }

    /* Main Workspace */
    .workspace {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      position: relative;
    }

    .ws-header {
      height: 80px;
      padding: 0 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }

    .note-title-active {
      font-family: 'Outfit';
      font-size: 20px;
      font-weight: 600;
    }

    .ws-actions {
      display: flex;
      gap: 12px;
    }

    .btn-action {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }

    .btn-action.primary {
      background: var(--accent);
      color: #000;
      border: none;
    }

    .btn-action:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }

    /* Editor & Preview Panes */
    .editor-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    #monaco-root {
      flex: 1;
    }

    #preview-root {
      flex: 1;
      border-left: 1px solid var(--border);
      padding: 40px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.1);
      display: none;
      /* Initially hidden */
    }

    /* Markdown Styling */
    .markdown-content {
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.7;
      font-size: 16px;
      color: #cbd5e1;
    }

    .markdown-content h1,
    .markdown-content h2 {
      font-family: 'Outfit';
      color: var(--text);
      margin-top: 1.5em;
    }

    .markdown-content code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Fira Code', monospace;
    }

    .markdown-content blockquote {
      border-left: 4px solid var(--accent);
      padding-left: 20px;
      margin: 20px 0;
      color: var(--text-dim);
    }

    /* Toast Notifications */
    #toast-shelf {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: #1e293b;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Loading */
    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }

    /* Switch View States */
    .view-section {
      display: none;
      flex: 1;
      height: 100%;
    }

    .view-section.active {
      display: flex;
    }
  </style>
</head>

<body>

  <!-- 1. Login Screen -->
  <div id="login-overlay">
    <div class="login-card">
      <i class="ri-brain-line" style="font-size: 50px; color: var(--accent); margin-bottom: 20px; display: block;"></i>
      <h1>Cognition Pro</h1>
      <p style="color: var(--text-dim);">連接您的 GitHub 筆記大腦</p>

      <div class="input-group">
        <label>GitHub Access Token (PAT)</label>
        <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
      </div>
      <div class="input-group">
        <label>儲存庫 (Repository)</label>
        <input type="text" id="gh-repo" value="cloud-notes">
      </div>

      <button class="btn-glow" onclick="Auth.login()">進入系統</button>
      <p style="font-size: 11px; margin-top: 24px; color: var(--text-dim);">
        提示：權杖僅儲存在瀏覽器本端 localStorage。
      </p>
    </div>
  </div>

  <!-- 2. Main Application App -->
  <div id="app-root">
    <!-- Sidebar Rail -->
    <nav class="nav-rail">
      <div class="nav-icon active" onclick="App.setView('notes')"><i class="ri-sticky-note-2-line"></i></div>
      <div class="nav-icon" onclick="App.setView('search')"><i class="ri-search-eye-line"></i></div>
      <div class="nav-icon" onclick="App.setView('settings')"><i class="ri-settings-4-line"></i></div>
      <div class="nav-icon" style="margin-top: auto; color: #ef4444;" onclick="Auth.logout()"><i
          class="ri-logout-box-r-line"></i></div>
    </nav>

    <!-- Explorer Pane -->
    <div class="explorer-pane">
      <div class="explorer-header">
        <h2>我的筆記</h2>
        <div class="nav-icon" style="width: 32px; height: 32px; margin: 0;" onclick="App.newNote()">
          <i class="ri-add-circle-fill"></i>
        </div>
      </div>
      <div class="search-box">
        <i class="ri-search-line"></i>
        <input type="text" id="file-search" placeholder="搜尋檔名..." oninput="App.filterFiles()">
      </div>
      <div id="file-list" class="file-list">
        <!-- Files injected here -->
      </div>
    </div>

    <!-- Main Workspace -->
    <main class="workspace">
      <header class="ws-header">
        <div class="note-title-active" id="active-filename">歡迎使用 Cognition</div>
        <div class="ws-actions">
          <button class="btn-action" onclick="App.togglePreview()" id="toggle-preview-btn">
            <i class="ri-layout-column-line"></i> 預覽模式
          </button>
          <button class="btn-action primary" onclick="App.saveCurrent()" id="save-btn">
            <i class="ri-save-3-line"></i> 儲存筆記
          </button>
        </div>
      </header>

      <div class="editor-container">
        <div id="monaco-root"></div>
        <div id="preview-root" class="markdown-content"></div>
      </div>
    </main>
  </div>

  <!-- 3. Toast Container -->
  <div id="toast-shelf"></div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // --- Core Configuration & State ---
    const GITHUB_API = 'https://api.github.com';
    const state = {
      token: localStorage.getItem('cognition_token'),
      repo: localStorage.getItem('cognition_repo') || 'cloud-notes',
      owner: localStorage.getItem('cognition_owner'),
      notes: [],
      current: null, // { name, sha, content }
      editor: null,
      isPreview: false
    };

    // --- Auth Module ---
    const Auth = {
      async login() {
        const token = document.getElementById('gh-token').value.trim();
        const repo = document.getElementById('gh-repo').value.trim();
        if (!token) return UI.toast('請輸入權杖', 'error');

        try {
          const res = await fetch(`${GITHUB_API}/user`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (!res.ok) throw new Error('API 授權失敗');
          const user = await res.json();

          localStorage.setItem('cognition_token', token);
          localStorage.setItem('cognition_owner', user.login);
          localStorage.setItem('cognition_repo', repo);
          location.reload();
        } catch (e) { UI.toast(e.message, 'error'); }
      },
      logout() {
        if (confirm('確定登出？此操作會清除本端快取數據。')) {
          localStorage.clear();
          location.reload();
        }
      }
    };

    // --- App Module ---
    const App = {
      async init() {
        if (state.token && state.owner) {
          document.getElementById('login-overlay').style.display = 'none';
          const app = document.getElementById('app-root');
          app.style.display = 'flex';
          setTimeout(() => app.classList.add('active'), 50);

          UI.initEditor();
          await this.fetchNotes();
        }
      },

      async fetchNotes() {
        try {
          // Cache busting prevents the directory from being stale
          const res = await fetch(`${GITHUB_API}/repos/${state.owner}/${state.repo}/contents?ref=main&t=${Date.now()}`, {
            headers: { 'Authorization': `token ${state.token}`, 'Cache-Control': 'no-cache' }
          });
          if (!res.ok) throw new Error('無法串接 GitHub 儲存庫');
          const data = await res.json();
          state.notes = data.filter(f => f.name.endsWith('.md') && f.name !== 'README.md');
          this.renderFileList();
        } catch (e) {
          UI.toast(e.message, 'error');
        }
      },

      renderFileList() {
        const listEl = document.getElementById('file-list');
        listEl.innerHTML = '';

        state.notes.sort((a, b) => a.name.localeCompare(b.name)).forEach(note => {
          const div = document.createElement('div');
          div.className = `file-item ${state.current?.name === note.name ? 'active' : ''}`;
          div.innerHTML = `<i class="ri-markdown-line"></i> <span>${note.name.replace('.md', '')}</span>`;
          div.onclick = () => this.loadNote(note);
          listEl.appendChild(div);
        });
      },

      async loadNote(note) {
        state.current = note;
        this.renderFileList();
        document.getElementById('active-filename').innerText = note.name.replace('.md', '');

        // Show loading shimmer in editor theoretically
        try {
          const res = await fetch(note.url, { headers: { 'Authorization': `token ${state.token}` } });
          const data = await res.json();
          state.current.sha = data.sha;
          const decoded = Utils.decodeBase64(data.content);
          state.editor.setValue(decoded);
          if (state.isPreview) this.updatePreview();
        } catch (e) { UI.toast('讀取失敗', 'error'); }
      },

      async saveCurrent() {
        if (!state.current) return UI.toast('請先選擇或建立一個筆記', 'error');

        const btn = document.getElementById('save-btn');
        btn.innerHTML = `<i class="ri-loader-4-line"></i> 正在上傳...`;
        btn.disabled = true;

        const content = state.editor.getValue();
        const b64 = Utils.encodeBase64(content);
        const path = state.current.name;

        const body = {
          message: `Cognition Update: ${path}`,
          content: b64,
          sha: state.current.sha || null,
          branch: 'main'
        };

        try {
          const res = await fetch(`${GITHUB_API}/repos/${state.owner}/${state.repo}/contents/${path}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${state.token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          if (res.ok) {
            const result = await res.json();
            state.current.sha = result.content.sha;
            UI.toast('儲存完成', 'success');

            // --- Optimistic UI Update ---
            // Instead of refetching the whole list immediately (which might lag),
            // we update the local SHA for the current item.
            const index = state.notes.findIndex(n => n.name === path);
            if (index === -1) {
              state.notes.push(result.content);
              this.renderFileList();
            } else {
              state.notes[index].sha = result.content.sha;
            }
          } else {
            const err = await res.json();
            throw new Error(err.message || '儲存失敗');
          }
        } catch (e) { UI.toast(e.message, 'error'); }
        finally {
          btn.innerHTML = `<i class="ri-save-3-line"></i> 儲存筆記`;
          btn.disabled = false;
        }
      },

      async newNote() {
        const name = prompt('筆記名稱：');
        if (!name) return;
        const filename = name.endsWith('.md') ? name : name + '.md';

        // Set state and open editor
        state.current = { name: filename, isNew: true };
        document.getElementById('active-filename').innerText = name;
        state.editor.setValue(`# ${name}\n\n在這裡開始寫作您的靈感...`);

        // Add to list optimistically so it's VISIBLE IMMEDIATELY
        if (!state.notes.find(n => n.name === filename)) {
          state.notes.push({ name: filename });
          this.renderFileList();
        }
        UI.toast('已建立暫存筆記，請記得按下儲存', 'success');
      },

      togglePreview() {
        state.isPreview = !state.isPreview;
        const prev = document.getElementById('preview-root');
        const btn = document.getElementById('toggle-preview-btn');

        if (state.isPreview) {
          prev.style.display = 'block';
          btn.innerHTML = `<i class="ri-edit-line"></i> 編輯模式`;
          this.updatePreview();
        } else {
          prev.style.display = 'none';
          btn.innerHTML = `<i class="ri-layout-column-line"></i> 預覽模式`;
        }
      },

      updatePreview() {
        const content = state.editor.getValue();
        document.getElementById('preview-root').innerHTML = marked.parse(content);
      },

      filterFiles() {
        const q = document.getElementById('file-search').value.toLowerCase();
        const items = document.querySelectorAll('.file-item');
        items.forEach(it => {
          const text = it.innerText.toLowerCase();
          it.style.display = text.includes(q) ? 'flex' : 'none';
        });
      }
    };

    // --- UI Utils ---
    const UI = {
      toast(msg, type = 'success') {
        const shelf = document.getElementById('toast-shelf');
        const t = document.createElement('div');
        t.className = 'toast';
        const icon = type === 'success' ? 'ri-checkbox-circle-fill' : 'ri-error-warning-fill';
        const color = type === 'success' ? '#10b981' : '#ef4444';
        t.innerHTML = `<i class="${icon}" style="color:${color}"></i> ${msg}`;
        shelf.appendChild(t);
        setTimeout(() => {
          t.style.opacity = '0';
          t.style.transform = 'translateY(10px)';
          setTimeout(() => t.remove(), 400);
        }, 3000);
      },

      initEditor() {
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], () => {
          state.editor = monaco.editor.create(document.getElementById('monaco-root'), {
            value: '# 開始筆記之旅\n\n點擊左側筆記開始編輯，或點擊 ' + ' 建立新筆記。',
            language: 'markdown',
            theme: 'vs-dark',
            automaticLayout: true,
            fontSize: 16,
            fontFamily: "'Fira Code', 'Inter', monospace",
            minimap: { enabled: false },
            padding: { top: 40 },
            wordWrap: 'on',
            lineNumbers: 'off',
            scrollbar: { verticalScrollbarSize: 0 }
          });

          state.editor.onDidChangeModelContent(() => {
            if (state.isPreview) App.updatePreview();
          });
        });
      }
    };

    // --- Utils ---
    const Utils = {
      decodeBase64(str) {
        return new TextDecoder().decode(Uint8Array.from(atob(str), c => c.charCodeAt(0)));
      },
      encodeBase64(str) {
        return btoa(new TextEncoder().encode(str).reduce((d, b) => d + String.fromCharCode(b), ''));
      }
    };

    // Entry
    App.init();
  </script>
</body>

</html>