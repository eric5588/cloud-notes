<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Cloud Notes v5.2 - Final Stable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.css">
  <style>
    :root {
      --bg-color: #f8fafc; --glass-bg: rgba(255, 255, 255, 0.9); --text-main: #0f172a; --text-sub: #475569;
      --sidebar-bg: #ffffff; --card-bg: #ffffff; --border-color: #e2e8f0; --primary-color: #2563eb;
    }
    [data-theme="dark"] {
      --bg-color: #0f172a; --glass-bg: rgba(30, 41, 59, 0.9); --text-main: #f1f5f9; --text-sub: #94a3b8;
      --sidebar-bg: #1e293b; --card-bg: #1e293b; --border-color: #334155; --primary-color: #3b82f6;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg-color); margin: 0; min-height: 100vh; overflow: hidden; color: var(--text-main); }
    #app-shell { display: flex; height: 100vh; opacity: 0; transition: opacity 0.5s; }
    .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px; z-index: 100; }
    .main-content { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-color); }
    .brand { font-weight: 800; font-size: 20px; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: var(--primary-color); }
    .btn-action { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; }
    #file-list { flex: 1; overflow-y: auto; }
    .file-link { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; text-decoration: none; color: var(--text-sub); font-size: 14px; margin-bottom: 4px; transition: 0.2s; }
    .file-link:hover { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); }
    .file-link.active { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); font-weight: 600; }
    
    #login-screen { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 360px; text-align: center; border: 1px solid var(--border-color); }
    input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 15px; font-size: 14px; background: var(--bg-color); color: var(--text-main); }
    
    #editor-overlay { position: absolute; inset: 0; background: var(--card-bg); z-index: 200; display: none; flex-direction: column; }
    .editor-header { height: 64px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
    #monaco-host { flex: 1; }
    .sidebar-toggle, .sidebar-nav { display: none !important; }
    .markdown-section { padding: 40px 60px !important; color: var(--text-main) !important; }
    .err-box { padding: 15px; border-radius: 10px; background: rgba(239, 68, 68, 0.1); color: #ef4444; font-size: 13px; margin-top: 20px; }
  </style>
</head>
<body data-theme="light">

  <div id="login-screen">
    <div class="login-card">
      <h1 style="margin:0 0 10px">Cloud Notes</h1>
      <p style="color:var(--text-sub); margin-bottom:25px">Ëº∏ÂÖ• Token ÂØÜÁ¢º</p>
      <input type="password" id="token-input" placeholder="GitHub Personal Access Token">
      <button class="btn-action" onclick="doLogin()">ÈÄ≤ÂÖ•Á≠ÜË®òÊú¨</button>
    </div>
  </div>

  <div id="app-shell">
    <div class="sidebar">
      <div class="brand">Cloud Notes</div>
      <button class="btn-action" onclick="newNote()"><i class="ri-add-line"></i> Êñ∞Â¢ûÁ≠ÜË®ò</button>
      <div id="file-list"></div>
      <div style="margin-top:auto; padding-top:15px; border-top:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
        <span onclick="logout()" style="cursor:pointer; font-size:12px; color:var(--text-sub)">ÁôªÂá∫</span>
        <span onclick="toggleTheme()" style="cursor:pointer; font-size:18px" id="theme-icon">‚òÄÔ∏è</span>
      </div>
    </div>
    <div class="main-content">
      <div class="editor-header" style="justify-content: flex-end; gap:10px;">
        <button class="btn-action" style="width:auto; background:transparent; color:var(--text-sub); border:1px solid var(--border-color); font-size:13px;" onclick="startEdit()"><i class="ri-edit-line"></i> Á∑®ËºØÊ≠§È†Å</button>
      </div>
      <div id="app"></div>
      <div id="editor-overlay">
        <div class="editor-header">
          <span id="editor-title" style="font-weight:600">Ê≠£Âú®Á∑®ËºØ</span>
          <div style="display:flex; gap:10px">
             <button class="btn-action" style="width:auto; background:#f1f5f9; color:#475569" onclick="closeEditor()">ÂèñÊ∂à</button>
             <button class="btn-action" style="width:auto; margin-bottom:0" onclick="saveContent()">ÂÑ≤Â≠òÁ≠ÜË®ò</button>
          </div>
        </div>
        <div id="monaco-host"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const STORAGE = {
      token: () => localStorage.getItem('gh_token'),
      owner: () => localStorage.getItem('gh_owner'),
      repo: () => localStorage.getItem('gh_repo') || 'cloud-notes'
    };
    let editor = null; let currentSha = null;

    async function init() {
      const theme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', theme);
      document.getElementById('theme-icon').innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

      if (STORAGE.token() && STORAGE.owner()) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-shell').style.opacity = '1';
        await refreshSidebar();
      }
    }

    async function doLogin() {
      const token = document.getElementById('token-input').value.trim();
      if(!token) return alert('Ë´ãËº∏ÂÖ• Token');
      try {
        const res = await fetch('https://api.github.com/user', { headers: { Authorization: `Bearer ${token}` } });
        if(!res.ok) throw new Error('Token ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúü');
        const user = await res.json();
        localStorage.setItem('gh_token', token);
        localStorage.setItem('gh_owner', user.login);
        location.reload();
      } catch(e) { alert(e.message); }
    }

    async function refreshSidebar() {
      const list = document.getElementById('file-list');
      list.innerHTML = '<div style="color:#94a3b8; font-size:13px; padding:10px">ÂêåÊ≠•‰∏≠...</div>';
      try {
        const res = await fetch(`https://api.github.com/repos/${STORAGE.owner()}/${STORAGE.repo()}/contents?ref=main`, {
          headers: { Authorization: `Bearer ${STORAGE.token()}`, 'Cache-Control': 'no-cache' }
        });
        if(!res.ok) throw new Error(`API ÈåØË™§: ${res.status}`);
        const files = await res.json();
        list.innerHTML = '';
        files.filter(f => f.name.toLowerCase().endsWith('.md') && f.name !== '_sidebar.md')
             .sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true}))
             .forEach(f => {
               const a = document.createElement('a');
               a.className = 'file-link' + (location.hash === `#/${f.name}` ? ' active' : '');
               a.href = `#/${f.name}`;
               a.innerHTML = `<i class="ri-file-text-line"></i> ${f.name.replace('.md','')}`;
               list.appendChild(a);
             });
      } catch(e) {
        list.innerHTML = `<div class="err-box">ËÆÄÂèñÂ§±Êïó: ${e.message}<br><button onclick="refreshSidebar()" style="margin-top:10px; cursor:pointer">ÈªûÊ≠§ÈáçË©¶</button></div>`;
      }
    }

    window.$docsify = {
      el: '#app', routerMode: 'hash', loadSidebar: false,
      plugins: [
        function(hook, vm) {
          hook.doneEach(() => {
            const path = location.hash.replace('#/', '') || 'README.md';
            fetchLatest(path);
            document.querySelectorAll('.file-link').forEach(el => {
               el.classList.toggle('active', el.getAttribute('href') === location.hash);
            });
          });
        }
      ]
    };

    async function fetchLatest(path) {
      const appEl = document.querySelector('#app');
      try {
        const res = await fetch(`https://api.github.com/repos/${STORAGE.owner()}/${STORAGE.repo()}/contents/${path}?ref=main`, {
          headers: { Authorization: `Bearer ${STORAGE.token()}`, 'Cache-Control': 'no-cache' }
        });
        if(res.ok) {
          const data = await res.json();
          currentSha = data.sha;
          const decoded = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
          appEl.innerHTML = `<div class="markdown-section">${marked.parse(decoded)}</div>`;
        } else {
          appEl.innerHTML = `<div style="text-align:center; padding:100px 50px"><h2>Á≠ÜË®ò‰∏çÂ≠òÂú®</h2><button class="btn-action" style="width:auto; padding:10px 40px" onclick="startEdit()">Á´ãÂç≥Âª∫Á´ã</button></div>`;
          currentSha = null;
        }
      } catch(e) { console.error('API Fetch failed', e); }
    }

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
    async function startEdit() {
      const path = location.hash.replace('#/', '') || 'README.md';
      document.getElementById('editor-overlay').style.display = 'flex';
      document.getElementById('editor-title').innerText = `Á∑®ËºØ: ${path}`;
      
      if(!editor) {
        await new Promise(r => require(['vs/editor/editor.main'], () => {
          editor = monaco.editor.create(document.getElementById('monaco-host'), {
            value: 'ËÆÄÂèñ‰∏≠...', language: 'markdown', automaticLayout: true,
            theme: document.body.getAttribute('data-theme') === 'dark' ? 'vs-dark' : 'vs-light'
          });
          editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, saveContent);
          r();
        }));
      }
      try {
        const res = await fetch(`https://api.github.com/repos/${STORAGE.owner()}/${STORAGE.repo()}/contents/${path}?ref=main`, {
          headers: { Authorization: `Bearer ${STORAGE.token()}`, 'Cache-Control': 'no-cache' }
        });
        if(res.ok) {
          const data = await res.json(); currentSha = data.sha;
          editor.setValue(new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0))));
        } else {
          editor.setValue(`# ${path.replace('.md','')}\n\nÂú®ÈÄôË£°Ëº∏ÂÖ•ÂÖßÂÆπ...`); currentSha = null;
        }
      } catch(e) { editor.setValue('ËÆÄÂèñÂ§±Êïó'); }
    }

    async function saveContent() {
      const path = location.hash.replace('#/', '') || 'README.md';
      const content = editor.getValue();
      const b64 = btoa(new TextEncoder().encode(content).reduce((d,b)=>d+String.fromCharCode(b),''));
      const body = { message: 'Cloud Note Update', content: b64, branch: 'main' };
      if (currentSha) body.sha = currentSha;

      try {
        const res = await fetch(`https://api.github.com/repos/${STORAGE.owner()}/${STORAGE.repo()}/contents/${path}`, {
          method: 'PUT', headers: { Authorization: `Bearer ${STORAGE.token()}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if(res.ok) {
          alert('ÂÑ≤Â≠òÂÆåÊàêÔºÅ'); closeEditor(); 
          await refreshSidebar();
          await fetchLatest(path);
        } else { alert('ÂÑ≤Â≠òÂ§±Êïó'); }
      } catch(e) { alert(e.message); }
    }

    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
    function newNote() {
      const name = prompt('Á≠ÜË®òÂêçÁ®±:', `note-${Date.now()}`);
      if(name) {
        const cleanName = name.endsWith('.md') ? name : name + '.md';
        window.location.hash = `#/${cleanName}`;
        setTimeout(startEdit, 300);
      }
    }
    function toggleTheme() {
       const next = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
       document.body.setAttribute('data-theme', next);
       localStorage.setItem('theme', next);
       if(editor) monaco.editor.setTheme(next === 'dark' ? 'vs-dark' : 'vs-light');
       document.getElementById('theme-icon').innerText = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }
    function logout() { if(confirm('ÁôªÂá∫Ôºü')){ localStorage.clear(); location.reload(); } }
    init();
  </script>
  <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
</body>
</html>
