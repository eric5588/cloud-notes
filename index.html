<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Cloud Notes v5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
  <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.css">
  
  <style>
    /* --- Theme & Base --- */
    :root {
      --bg-color: #f5f7fa; --glass-bg: rgba(255, 255, 255, 0.85); --text-main: #1e293b; --text-sub: #64748b;
      --sidebar-bg: rgba(255,255,255,0.8); --card-bg: #ffffff; --border-color: rgba(0,0,0,0.05); --primary-color: #2563eb;
    }
    [data-theme="dark"] {
      --bg-color: #111111; --glass-bg: rgba(30, 30, 30, 0.85); --text-main: #e2e8f0; --text-sub: #94a3b8;
      --sidebar-bg: rgba(20, 20, 20, 0.9); --card-bg: #1e1e1e; --border-color: rgba(255,255,255,0.1); --primary-color: #60a5fa;
    }
    * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-color); margin: 0; height: 100vh; overflow: hidden; color: var(--text-main); }

    /* Layout */
    #app-shell { display: flex; height: 100vh; opacity: 0; transition: opacity 0.5s; }
    .sidebar-container {
      width: 280px; background: var(--sidebar-bg); backdrop-filter: blur(20px); border-right: 1px solid var(--border-color);
      display: flex; flex-direction: column; padding: 20px; z-index: 20;
    }
    .main-area {
      flex: 1; position: relative; overflow-y: auto; background: var(--card-bg); margin: 15px;
      border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; border: 1px solid var(--border-color);
    }
    
    /* Sidebar Elements */
    .brand { font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 10px; color: var(--text-main); margin-bottom: 20px; }
    .new-btn {
      background: var(--primary-color); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; font-weight: 600;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
    }
    .new-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3); }

    /* Dynamic File List */
    #file-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
    .file-item {
      padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; color: var(--text-sub);
      display: flex; align-items: center; gap: 8px; font-size: 14px; text-decoration: none;
    }
    .file-item:hover { background: rgba(127,127,127,0.1); color: var(--text-main); }
    .file-item.active { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); font-weight: 500; }

    /* Login Screen */
    #login-screen {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg-color); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .login-box {
      background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color);
    }
    .inp-field {
      width: 100%; padding: 12px 15px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 10px;
      background: var(--bg-color); color: var(--text-main); font-size: 14px;
    }
    .btn-login { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }

    /* Editor Overlay */
    #editor-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg); z-index: 100;
      display: none; flex-direction: column;
    }
    .editor-top { height: 60px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
    #monaco-host { flex: 1; }
    
    /* Hide Docsify Defaults */
    .sidebar-toggle, .sidebar { display: none !important; }
    .markdown-section { color: var(--text-main) !important; padding: 40px 60px !important; }
    .markdown-section code { background: rgba(127,127,127,0.1) !important; color: var(--primary-color) !important; }
  </style>
</head>
<body data-theme="light">

  <!-- Login -->
  <div id="login-screen">
    <div class="login-box">
      <div style="font-size: 40px; margin-bottom: 20px;">üöÄ</div>
      <h1>Cloud Notes v5</h1>
      <p style="color:var(--text-sub)">Âç≥ÊôÇÂêåÊ≠•„ÉªÁÑ°ÈôêÁ©∫Èñì</p>
      <input type="password" id="inp-password" class="inp-field" placeholder="GitHub Token" autocomplete="current-password">
      <button class="btn-login" id="login-btn" onclick="attemptLogin()">ÈÄ≤ÂÖ•Á≥ªÁµ±</button>
      <div style="margin-top: 20px;"><a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" style="color:var(--text-sub); font-size:12px;">ÂøòË®òÂØÜÁ¢º?</a></div>
    </div>
  </div>

  <!-- App -->
  <div id="app-shell">
    <div class="sidebar-container">
      <div class="brand"><i class="ri-cloud-windy-line"></i> Cloud Notes</div>
      <button class="new-btn" onclick="createNewNote()"><i class="ri-add-line"></i> Êñ∞Â¢ûÁ≠ÜË®ò</button>
      
      <!-- Dynamic File List -->
      <div id="file-list"></div>
      
      <div style="margin-top: auto; display:flex; justify-content:space-between; align-items:center; padding-top:15px; border-top:1px solid var(--border-color);">
        <div style="font-size: 12px; color: var(--text-sub); cursor: pointer;" onclick="logout()">ÁôªÂá∫</div>
        <div style="cursor: pointer;" onclick="toggleTheme()" id="theme-icon">‚òÄÔ∏è</div>
      </div>
    </div>

    <div class="main-area">
      <div class="editor-top" style="justify-content: flex-end; gap:10px;">
         <div id="loading-indicator" style="margin-right:auto; font-size:12px; color:var(--text-sub); display:none;">ÂêåÊ≠•‰∏≠...</div>
         <button class="btn-login" style="width:auto; padding:6px 15px; font-size:14px; background:transparent; color:var(--text-sub); border:1px solid var(--border-color);" onclick="openEditor()"><i class="ri-edit-line"></i> Á∑®ËºØ</button>
      </div>
      
      <div id="app"></div> <!-- Docsify Render Area -->

      <!-- Editor -->
      <div id="editor-overlay">
        <div class="editor-top">
          <div style="font-weight: 600;" id="edit-title">Á∑®ËºØÊ®°Âºè</div>
          <div style="display: flex; gap: 10px;">
            <button class="btn-login" style="width:auto; padding:6px 15px; background: #eee; color:#333;" onclick="triggerImageUpload()">üì∑ ÂúñÁâá</button>
            <input type="file" id="img-upload-hidden" style="display:none" onchange="handleFileSelect(this)">
            <button class="btn-login" style="width:auto; padding:6px 15px; background: #eee; color:#333;" onclick="cancelEdit()">ÂèñÊ∂à</button>
            <button class="btn-login" style="width:auto; padding:6px 15px;" onclick="saveFile()">ÂÑ≤Â≠ò</button>
          </div>
        </div>
        <div id="monaco-host"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
  <script>
    const CONFIG = { 
      token: localStorage.getItem('gh_pat'),
      owner: localStorage.getItem('gh_owner'),
      repo: localStorage.getItem('gh_repo') || 'cloud-notes'
    };
    let editorInstance = null, currentSha = null, isNewFile = false;

    // --- Init & Auth ---
    function init() {
      const theme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', theme);
      document.getElementById('theme-icon').innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

      if (CONFIG.token && CONFIG.owner) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-shell').style.opacity = '1';
        document.querySelector('.brand').innerHTML = `<i class="ri-cloud-windy-line"></i> ${CONFIG.owner}`;
        fetchFileList(); // Load Sidebar Immediately
      }
    }

    window.attemptLogin = async function() {
      const token = document.getElementById('inp-password').value.trim();
      if(!token) return alert('Ë´ãËº∏ÂÖ• Token');
      document.getElementById('login-btn').innerText = 'È©óË≠â‰∏≠...';
      
      try {
        const userRes = await fetch('https://api.github.com/user', { headers: { Authorization: `token ${token}` } });
        if(!userRes.ok) throw new Error('Token ÁÑ°Êïà');
        const user = await userRes.json();
        
        // Auto-detect or create repo check could go here, simplifying for v5
        localStorage.setItem('gh_pat', token);
        localStorage.setItem('gh_owner', user.login);
        localStorage.setItem('gh_repo', 'cloud-notes');
        
        location.reload();
      } catch(e) {
        alert('ÁôªÂÖ•Â§±Êïó: ' + e.message);
        document.getElementById('login-btn').innerText = 'ÈÄ≤ÂÖ•Á≥ªÁµ±';
      }
    }

    // --- Dynamic Sidebar (The Magic) ---
    async function fetchFileList() {
      const listEl = document.getElementById('file-list');
      listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ËºâÂÖ•‰∏≠...</div>';
      
      try {
        const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/`, {
          headers: { Authorization: `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
        });
        if(!res.ok) throw new Error('ÁÑ°Ê≥ïËÆÄÂèñÊ™îÊ°àÂàóË°®');
        const files = await res.json();
        
        listEl.innerHTML = '';
        files.filter(f => f.name.endsWith('.md') && f.name !== '_sidebar.md')
             .sort((a,b) => a.name.localeCompare(b.name))
             .forEach(f => {
               const item = document.createElement('a');
               item.className = 'file-item';
               item.href = `#/${f.name}`;
               item.innerHTML = `<i class="ri-file-text-line"></i> ${f.name.replace('.md','')}`;
               item.onclick = () => {
                 document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                 item.classList.add('active');
               };
               listEl.appendChild(item);
             });
      } catch(e) {
        console.error(e);
        listEl.innerHTML = '<div style="padding:10px; color:red;">ËÆÄÂèñÂ§±Êïó</div>';
      }
    }

    // --- Docsify ---
    window.$docsify = {
      el: '#app', routerMode: 'hash', loadSidebar: false, // We handle sidebar
      plugins: [
        function(hook, vm) {
          hook.beforeEach(function(content, next) {
             // If Docsify gets 404 via CDN, we intercept manually in `fail`? 
             // Docsify doesn't have a clean fetch hook.
             // We rely on the initial load state.
             next(content);
          });
          hook.doneEach(function() {
             const content = document.querySelector('.markdown-section');
             if (content && (content.innerText.includes('404') || content.innerText === '')) {
                // CDN failed (too new). Let's fetch via API!
                const path = location.hash.replace('#/', '') || 'README.md';
                fetchContentViaAPI(path);
             }
          });
        }
      ]
    };

    async function fetchContentViaAPI(path) {
       document.querySelector('#app').innerHTML = '<div style="padding:50px; text-align:center;">üöÄ Ê≠£Âú®ÈÄèÈÅé API ËÆÄÂèñÊúÄÊñ∞ÂÖßÂÆπ...</div>';
       try {
         const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`, {
            headers: { Authorization: `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
         });
         if(res.ok) {
           const data = await res.json();
           const decoded = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
           // Very rudimentary markdown render for fallback
           document.querySelector('#app').innerHTML = `<div class="markdown-section">${marked.parse(decoded)}</div>`;
         } else {
           document.querySelector('#app').innerHTML = `<div style="text-align:center; padding: 50px;"><h2>üìù Á≠ÜË®ò‰∏çÂ≠òÂú®</h2><button class="btn-login" style="width:auto;" onclick="openEditor()">Á´ãÂç≥Âª∫Á´ã</button></div>`;
           isNewFile = true;
         }
       } catch(e) {
         document.querySelector('#app').innerHTML = 'ËÆÄÂèñÈåØË™§';
       }
    }

    // --- Editor ---
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
    window.openEditor = async function() {
      const path = location.hash.replace('#/', '').split('?')[0] || 'README.md';
      document.getElementById('editor-overlay').style.display = 'flex';
      document.getElementById('edit-title').innerText = isNewFile ? 'Êñ∞Á≠ÜË®ò' : `Á∑®ËºØ: ${path}`;
      
      if (!editorInstance) {
         await new Promise(r => require(['vs/editor/editor.main'], () => {
             editorInstance = monaco.editor.create(document.getElementById('monaco-host'), {
                 value: 'Loading...', language: 'markdown', automaticLayout: true, theme: document.body.getAttribute('data-theme')==='dark'?'vs-dark':'vs-light'
             });
             editorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, saveFile);
             r();
         }));
      }
      
      if(isNewFile) {
        editorInstance.setValue(`# ${path.replace('.md','')}\n`);
        currentSha = null;
      } else {
        // Always fetch latest from API for editing to avoid conflict
        try {
          const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`, {
             headers: { Authorization: `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
          });
          if(res.ok) {
             const data = await res.json();
             currentSha = data.sha;
             editorInstance.setValue(new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0))));
          } else { editorInstance.setValue(''); currentSha = null; }
        } catch(e) {}
      }
    }

    window.saveFile = async function() {
      const path = location.hash.replace('#/', '').split('?')[0] || 'README.md';
      const content = editorInstance.getValue();
      const encoded = btoa(new TextEncoder().encode(content).reduce((d,b)=>d+String.fromCharCode(b),''));
      
      const body = { message: 'Save via Cloud Notes', content: encoded };
      if (currentSha) body.sha = currentSha;
      
      try {
        const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`, {
           method: 'PUT', headers: { Authorization: `token ${CONFIG.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        });
        if(res.ok) {
           const data = await res.json(); currentSha = data.content.sha; isNewFile = false;
           alert('ÂÑ≤Â≠òÊàêÂäü');
           document.getElementById('editor-overlay').style.display = 'none';
           
           // Refresh List & Content Immediately
           fetchFileList();
           fetchContentViaAPI(path);
        } else { alert('ÂÑ≤Â≠òÂ§±Êïó'); }
      } catch(e) { alert(e.message); }
    }
    
    window.cancelEdit = () => document.getElementById('editor-overlay').style.display = 'none';
    window.toggleTheme = () => {
       const next = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
       document.body.setAttribute('data-theme', next);
       localStorage.setItem('theme', next);
       document.getElementById('theme-icon').innerText = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
       if(editorInstance) monaco.editor.setTheme(next==='dark'?'vs-dark':'vs-light');
    }
    window.logout = () => { localStorage.clear(); location.reload(); }
    window.createNewNote = () => {
       const name = prompt('Á≠ÜË®òÂêçÁ®±:', `note-${Date.now()}`);
       if(name) { window.isNewFile = true; window.location.hash = `#/${name}.md`; setTimeout(openEditor, 100); }
    }

    window.triggerImageUpload = () => document.getElementById('img-upload-hidden').click();
    window.handleFileSelect = async (input) => {
       if(!input.files[0]) return;
       const file = input.files[0];
       const reader = new FileReader(); reader.readAsDataURL(file);
       reader.onloadend = async () => {
          const b64 = reader.result.split(',')[1];
          const name = `images/${Date.now()}.png`;
          editorInstance.trigger('keyboard', 'type', {text: `![Img](${name})`});
          await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${name}`, {
             method: 'PUT', headers: { Authorization: `token ${CONFIG.token}`, 'Content-Type': 'application/json' },
             body: JSON.stringify({ message: 'Img', content: b64 })
          });
       }
    }

    init();
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
</body>
</html>
