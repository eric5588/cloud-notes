<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>個人雲端筆記</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="Personal Cloud Notes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

  <!-- Notion-like Theme -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">

  <!-- Monaco Editor -->
  <link rel="stylesheet" data-name="vs/editor/editor.main"
    href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.css">

  <style>
    /* -------------------------------------------------------------------------- */
    /*                                Design System                               */
    /* -------------------------------------------------------------------------- */
    :root {
      --theme-color: #2F3437;
      --sidebar-width: 280px;
      --bg-color: #ffffff;
      --text-color: #37352f;
      --accent-color: #2ea44f;
      --modal-bg: rgba(15, 15, 15, 0.6);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
      color: var(--text-color);
      letter-spacing: -0.01em;
    }

    /* -------------------------------------------------------------------------- */
    /*                                Custom UI Elements                          */
    /* -------------------------------------------------------------------------- */

    /* Floating Header Actions */
    .header-actions {
      position: fixed;
      top: 15px;
      right: 20px;
      z-index: 100;
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background-color: var(--accent-color);
      color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:hover {
      background-color: #2c974b;
    }

    .btn-secondary {
      background-color: white;
      color: var(--text-color);
      border-color: #e0e0e0;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn-secondary:hover {
      background-color: #f7f7f5;
    }

    /* -------------------------------------------------------------------------- */
    /*                                Login Modal                                 */
    /* -------------------------------------------------------------------------- */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--modal-bg);
      backdrop-filter: blur(4px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      /* Important for padding */
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .help-text {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
      display: block;
    }

    /* -------------------------------------------------------------------------- */
    /*                                Editor Modal                                */
    /* -------------------------------------------------------------------------- */
    #editor-container {
      display: none;
      /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: white;
      z-index: 1500;
      display: none;
      flex-direction: column;
    }

    .editor-header {
      height: 50px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: #fff;
    }

    .file-status {
      font-size: 14px;
      color: #666;
      font-family: monospace;
    }

    #monaco-host {
      flex: 1;
      overflow: hidden;
    }

    /* -------------------------------------------------------------------------- */
    /*                                Sidebar & Content                          */
    /* -------------------------------------------------------------------------- */
    .sidebar {
      background-color: #F7F7F5;
      padding-top: 20px;
    }

    .app-name-link {
      display: none;
      /* Hide default title */
    }

    /* New Note Button in Sidebar */
    .new-note-btn {
      margin: 10px 20px;
      display: block;
      text-align: center;
      padding: 8px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      color: #333;
      text-decoration: none;
      font-size: 13px;
      transition: all 0.2s;
    }

    .new-note-btn:hover {
      background: #f0f0f0;
      color: #000;
      text-decoration: none !important;
    }

    .content {
      padding-top: 60px;
      /* Space for hidden header */
    }
  </style>
</head>

<body>

  <!-- App Container -->
  <div id="app">載入中...</div>

  <!-- Header Buttons -->
  <div class="header-actions">
    <button class="btn btn-primary" onclick="window.location.hash = '#/new-note-' + Date.now()">+ 新增筆記</button>
    <button class="btn btn-secondary" onclick="openEditor()" id="edit-btn">✎ 編輯</button>
    <button class="btn btn-secondary" onclick="showLoginModal()">⚙ 設定</button>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-title">雲端筆記設定</div>

      <div class="input-group">
        <label>GitHub Token (PAT)</label>
        <input type="password" id="input-token" placeholder="ghp_xxxxxxxxxxxx">
        <a href="https://github.com/settings/tokens" target="_blank" class="help-text">取得 Token (需勾選 'repo' 權限)</a>
      </div>

      <div class="input-group">
        <label>使用者名稱 (Owner)</label>
        <input type="text" id="input-owner" placeholder="例如: eric5588">
      </div>

      <div class="input-group">
        <label>倉庫名稱 (Repo)</label>
        <input type="text" id="input-repo" placeholder="例如: cloud-notes">
      </div>

      <div style="text-align: right; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeLoginModal()">取消</button>
        <button class="btn btn-primary" onclick="saveLogin()">儲存並登入</button>
      </div>
    </div>
  </div>

  <!-- Editor Container -->
  <div id="editor-container">
    <div class="editor-header">
      <div class="file-status" id="editor-filename">Loading...</div>
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-secondary" onclick="closeEditor()">取消</button>
        <button class="btn btn-primary" onclick="saveToGitHub()">儲存 (Ctrl+S)</button>
      </div>
    </div>
    <div id="monaco-host"></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

  <script>
    // --------------------------------------------------------------------------
    //                                CONFIG Logic                              
    // --------------------------------------------------------------------------
    let CONFIG = {
      owner: localStorage.getItem('gh_owner') || '',
      repo: localStorage.getItem('gh_repo') || '',
      branch: 'main',
      token: localStorage.getItem('gh_pat') || ''
    };

    function showLoginModal() {
      document.getElementById('input-token').value = CONFIG.token;
      document.getElementById('input-owner').value = CONFIG.owner;
      document.getElementById('input-repo').value = CONFIG.repo;
      document.getElementById('login-modal').style.display = 'flex';
    }

    function closeLoginModal() {
      document.getElementById('login-modal').style.display = 'none';
    }

    function saveLogin() {
      const token = document.getElementById('input-token').value.trim();
      const owner = document.getElementById('input-owner').value.trim();
      const repo = document.getElementById('input-repo').value.trim();

      if (!token || !owner || !repo) {
        alert('請填寫所有欄位');
        return;
      }

      localStorage.setItem('gh_pat', token);
      localStorage.setItem('gh_owner', owner);
      localStorage.setItem('gh_repo', repo);

      CONFIG.token = token;
      CONFIG.owner = owner;
      CONFIG.repo = repo;

      closeLoginModal();
      alert('設定已儲存！');
      location.reload();
    }

    // Auto-show login if missing config
    if (!CONFIG.token || !CONFIG.owner) {
      setTimeout(showLoginModal, 1000);
    }

    // --------------------------------------------------------------------------
    //                                DOCSIFY Setup                             
    // --------------------------------------------------------------------------
    window.$docsify = {
      name: '雲端筆記',
      repo: '',
      loadSidebar: true,
      subMaxLevel: 3,
      auto2top: true,
      search: 'auto',
      notFoundPage: false, // We handle 404 manually for "New Note" logic
      plugins: [
        function (hook, vm) {
          hook.beforeEach(function (content) {
            // Inject generic sidebar button hack via string replacement isn't ideal,
            // better to manipulate DOM in doneEach or use sidebar.md
            return content;
          });

          hook.doneEach(function () {
            // Inject "New Note" into sidebar if not there
            const sidebar = document.querySelector('.sidebar-nav');
            if (sidebar && !document.querySelector('.new-note-btn')) {
              const btn = document.createElement('a');
              btn.className = 'new-note-btn';
              btn.innerText = '+ 新增筆記';
              btn.href = '#/Untitled-' + Date.now();
              sidebar.insertBefore(btn, sidebar.firstChild);
            }

            // Update current file tracking
            window.currentFilePath = vm.route.file;

            // Check for 404 (Docsify renders "404 - Not found" text usually)
            // But better logic: check if content element is essentially empty or has specific class
            // Actually, we can check if file exists via API when entering Edit Mode.
            // For now, let's assume if user clicks Edit on a 404 page, they want to create it.
          });
        }
      ]
    };

    // --------------------------------------------------------------------------
    //                                EDITOR Logic                              
    // --------------------------------------------------------------------------
    let editorInstance = null;
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

    window.openEditor = async function () {
      if (!CONFIG.token) {
        showLoginModal();
        return;
      }

      const path = window.currentFilePath;
      document.getElementById('editor-container').style.display = 'flex';
      document.getElementById('editor-filename').innerText = `正在編輯: ${path}`;

      // Initialize Monaco first if needed
      if (!editorInstance) {
        await new Promise(resolve => require(['vs/editor/editor.main'], () => {
          editorInstance = monaco.editor.create(document.getElementById('monaco-host'), {
            value: 'Loading...',
            language: 'markdown',
            theme: 'vs-light',
            wordWrap: 'on',
            minimap: { enabled: false },
            fontSize: 16,
            lineHeight: 28,
            padding: { top: 20, bottom: 20 },
            automaticLayout: true
          });

          // Image Paste
          editorInstance.getDomNode().addEventListener('paste', handleImagePaste);
          // Ctrl+S to save
          editorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, saveToGitHub);

          resolve();
        }));
      }

      // Fetch Content (Check if exists)
      const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}?ref=${CONFIG.branch}`;

      try {
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${CONFIG.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (response.status === 404) {
          // NEW FILE MODE
          window.isNewFile = true;
          window.currentFileSha = null;
          editorInstance.setValue(`# ${path.replace('.md', '').replace('/', '')}\n\n`);
          document.getElementById('editor-filename').innerText = ` ✨ 新增筆記: ${path}`;
        } else {
          // EDIT MODE
          if (!response.ok) throw new Error('讀取錯誤');
          const data = await response.json();
          window.isNewFile = false;
          window.currentFileSha = data.sha;
          const content = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
          editorInstance.setValue(content);
        }
      } catch (e) {
        alert(e.message);
        closeEditor();
      }
    };

    window.closeEditor = function () {
      document.getElementById('editor-container').style.display = 'none';
      if (window.isNewFile) history.back();
    };

    window.saveToGitHub = async function () {
      const content = editorInstance.getValue();
      const contentEncoded = btoa(new TextEncoder().encode(content).reduce((data, byte) => data + String.fromCharCode(byte), ''));
      const path = window.currentFilePath;

      const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`;

      const commitMsg = window.isNewFile ? `Create ${path}` : `Update ${path}`;

      const body = {
        message: commitMsg,
        content: contentEncoded,
        branch: CONFIG.branch
      };

      if (!window.isNewFile && window.currentFileSha) {
        body.sha = window.currentFileSha;
      }

      try {
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${CONFIG.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          const data = await response.json();
          window.currentFileSha = data.content.sha; // Update SHA
          window.isNewFile = false;
          alert('儲存成功！');
          document.getElementById('editor-container').style.display = 'none';

          // Wait a bit for GitHub Pages then reload
          setTimeout(() => location.reload(), 2000);
        } else {
          const err = await response.json();
          alert('儲存失敗: ' + err.message);
        }
      } catch (e) {
        alert('網路錯誤: ' + e.message);
      }
    };

    // --------------------------------------------------------------------------
    //                                IMAGE Logic                               
    // --------------------------------------------------------------------------
    async function handleImagePaste(e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let index in items) {
        const item = items[index];
        if (item.kind === 'file' && item.type.includes('image/')) {
          e.preventDefault();
          const blob = item.getAsFile();
          await uploadImage(blob);
          return;
        }
      }
    }

    async function uploadImage(blob) {
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = async function () {
        const base64data = reader.result.split(',')[1];
        const filename = `images/${Date.now()}.png`; // Simple timestamp name
        const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${filename}`;

        try {
          // Should add loading indicator here
          const response = await fetch(url, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${CONFIG.token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Upload image ${filename}`,
              content: base64data,
              branch: CONFIG.branch
            })
          });

          if (response.ok) {
            const data = await response.json();
            const position = editorInstance.getPosition();
            // Use raw.githubusercontent or relative path? Relative is safer for Docsify
            // data.content.download_url is full URL. Let's use relative for portability.
            const textToInsert = `\n![Image](${filename})\n`;
            editorInstance.executeEdits("", [{
              range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
              text: textToInsert,
              forceMoveMarkers: true
            }]);
          } else {
            console.error('Image upload failed');
            alert('圖片上傳失敗');
          }
        } catch (e) {
          console.error(e);
        }
      }
    }
  </script>

  <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
</body>

</html>